#!/usr/bin/env bash

set -eo pipefail

# Version handling
if [[ "${1:-}" == "--version" || "${1:-}" == "-v" ]]; then
    script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    # Try different VERSION file locations
    for version_file in \
        "$script_dir/../VERSION" \
        "$HOME/.local/lib/functional-shell/VERSION" \
        "/usr/local/lib/functional-shell/VERSION"; do
        if [ -f "$version_file" ]; then
            echo "map $(cat "$version_file")"
            exit 0
        fi
    done
    echo "map (unknown version)"
    exit 0
fi

# Show help if requested
if [[ "${1:-}" == "--help" || "${1:-}" == "-h" ]]; then
    cat << 'EOF'
map - Apply operations to each line of input

USAGE:
    map <operation> [args...]
    map --version
    map --help

DESCRIPTION:
    Reads lines from stdin and applies the specified operation to each line.
    Operations are organized by category: arithmetic, string, file, comparison, etc.

EXAMPLES:
    # String operations
    echo "hello world" | map to_upper           # HELLO WORLD
    ls | map append ".bak"                      # Add .bak to each filename
    
    # Arithmetic operations  
    seq 1 5 | map add 10                       # Add 10 to each number
    seq 1 10 | map mul 2                       # Multiply each by 2
    
    # File operations
    find . -name "*.txt" | map basename         # Get just filenames
    ls -1 | map abspath                         # Convert to absolute paths
    
    # Chaining with pipes
    find . -name "*.log" | map basename | map to_upper

COMMON OPERATIONS:
    Arithmetic: add, sub, mul, pow, even, odd
    String:     to_upper, to_lower, reverse, append, prepend, len
    File:       basename, dirname, abspath, strip_ext
    Other:      id, identity

For complete list of operations, see the README or run:
    map invalid_operation  # Shows available operations

See also: filter(1)
EOF
    exit 0
fi

# Show usage if no arguments
if [[ $# -eq 0 ]]; then
    echo "Usage: map <operation> [args...]" >&2
    echo "       map --help" >&2
    echo "       map --version" >&2
    exit 1
fi

# Determine script location and set lib_dir
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Check if this is a symlinked executable and resolve the real location
if [ -L "${BASH_SOURCE[0]}" ]; then
    real_script="$(readlink "${BASH_SOURCE[0]}")"
    if [[ "$real_script" = /* ]]; then
        # Absolute path
        real_script_dir="$(cd "$(dirname "$real_script")" && pwd)"
    else
        # Relative path
        real_script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/$(dirname "$real_script")" && pwd)"
    fi
    
    # Check if lib directory exists relative to real script location
    if [ -d "$real_script_dir/../lib" ]; then
        lib_dir="$real_script_dir/../lib"
    fi
fi

# Fallback location checks
if [ -z "${lib_dir:-}" ]; then
    if [ -f "$script_dir/../lib/core/functions/_map" ]; then
        # Development mode - lib directory is relative to script
        lib_dir="$script_dir/../lib"
    elif [ -d "$HOME/.local/lib/functional-shell" ]; then
        # Local install mode - use ~/.local/lib/functional-shell
        lib_dir="$HOME/.local/lib/functional-shell"
    else
        # System install mode - use /usr/local/lib/functional-shell
        lib_dir="/usr/local/lib/functional-shell"
    fi
fi

source "$lib_dir/core/functions/_map"

source "$lib_dir/operations/arithmetic"
source "$lib_dir/operations/file_and_dir"
source "$lib_dir/operations/comparison"
source "$lib_dir/operations/string"
source "$lib_dir/operations/other"

_map "$@"
